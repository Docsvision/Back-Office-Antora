= Изменить состояние карточки "Задание"

Согласно стандартному набору состояний, который устанавливается для карточки в момент создания её вида, жизненный цикл карточки начинается с запуска задания и оканчивается переходом `Завершить задание`. Каждый переход между состояниями фиксируется в журнале операций и переходов.

Операция *Изменить*, доступная в состояниях `Отклонено` и `Отозвано`, используется, чтобы уже запущенное задание можно было изменить и начать заново. При этом карточка возвращается в состояние `Инициализация`, а в журнал добавляется соответствующая запись.

В состоянии `Завершено` ни одно из действий не может быть применено к карточке.

В таблицах указаны доступные действия для каждого состояния.

[options="header"]
|===
|Состояние/операция |Отправить |Изменить |Отозвать |Отклонить |Отложить |В работу |Делегировать

|Инициализация |X | | | | | |
|Не начато | | |X |X | |X |X
|В работе | | |X |X |X | |X
|Отклонено | |X |X | | |X |
|Отозвано | |X | | | | |
|Отложено | | |X |X | |X |
|Делегировано | | |X |X | |X |X
|Возврат с делегирования | | |X | | | |
|Завершено | | | | | | |
|На приёмке | | |X | | | |
|На доработке | | |X | |X |X |X
|===

[options="header"]
|===
|Состояние/операция |Не брать в работу |Завершить |Прекратить исполнение |Отменить делегирование |На доработку |Принять

|Инициализация | | | | | |
|Не начато | |X | | | |
|В работе |X |X |X |X | |
|Отклонено | | | | | |
|Отозвано | | | | | |
|Отложено | | | | | |
|Делегировано | | | |X | |
|Возврат с делегирования | |X | | | |
|Завершено | | | | | |
|На приёмке | | |X | |X |X
|На доработке | | |X | | |
|===

[#start]
== Запустить задание

Запуском задания называется выполнение перехода от первого состояния к следующему (в соответствии с настройками в Конструкторе состояний).

. Создайте карточку задания.
. Проверьте, что в карточке задания заполнены следующие поля:
* xref:task/create.adoc#author[Автор].
* xref:task/create.adoc#performer[Исполнитель].
* xref:task/create.adoc#name[Название].
* xref:task/create.adoc#name[Содержание].
. Нажмите на кнопку image:buttons/perform.png[Цветные квадратики] *Выполнить* на ленте карточки.
+
Если какое-то поле не заполнено, переход в следующее состояние не будет выполнен, и пользователь увидит предупреждающее сообщение.

Когда задание запущено, нажатие на раскрывающийся список у кнопки *Выполнить* отобразит доступные переходы. На данном этапе задание может быть _взято в работу, завершено, отклонено, делегировано_ или _отозвано_.

.Возможные переходы для запущенного задания
image::task-transitions.png[Возможные переходы для запущенного задания]

[#work]
== Взять задание в работу

Данная операция переводит карточку в состояние _В работе_.

.Операция может быть выполнена в следующих состояниях (на основе стандартного "Автомата состояний"):
* `На начато` -- основной сценарий, исполнитель приступает к работе над заданием.
* `Отклонено` -- исполнитель ранее отклонил задание.
* `Отложено` -- исполнитель возвращает в работу отложенное задание.
* `Делегировано` -- новый исполнитель приступает к работе над делегированным ему заданием.
* `Возврат с делегирования` -- сотрудник, делегировавший задание обрабатывает возврат.
* `На доработке` -- по результатам контроля задание возвращено на доработку.

При выполнении перехода _В работу_ исполнителем задания назначается текущий пользователь.

Когда задание взято в работу, в списке доступных операций появляется пункт *Вернуть в "Не начато"*. Данная операция противоположна по смыслу взятию задания в работу и предназначена для тех случаев, когда исполнитель желает вернуть задание в состояние, предшествовавшее взятию в работу.

Если задание берет в работу не назначенный исполнитель, то задание автоматически делегируется ему.

[#reject]
== Отклонить задание

Данная операция предусмотрена для тех случаев, когда исполнитель желает отказаться от выполнения задания. Отклонить можно как напрямую адресованное задание, так и делегированное.

.Операция может быть выполнена в следующих состояниях (на основе стандартного "автомата состояний"):
* _На начато_.
* _Делегировано_.
* _В работе_.
* _Отложено_.

Если в настройках задания (или вида) xref:task/advanced-settings.adoc#comment[настроен] запрос комментария при отклонении задания, будет выведена форма для ввода комментария, лишь после заполнения которой можно будет отклонить задание.

[#postpone]
== Отложить задание

Операция *Отложить* изменяет лишь состояние карточки и делает соответствующую запись в журнале событий. Это состояние может быть использовано, например, когда исполнитель собирается приступить к выполнению задания через значительный промежуток времени.

[#recall]
== Отозвать задание

Операция переводит карточку в состояние `Отозвано`. Если для отзываемого задания есть дочерние, будет выведено предупреждение, с возможностью подтвердить или отклонить отзыв дочерних заданий.

Отозвать можно запущенное задание в любом состоянии кроме `Завершено` и начального состояния `Инициализация`. При отзыве все дочерние задания удаляются.

[#delegate]
== Делегировать задание

При делегировании задания заменяется текущий исполнитель. Предыдущий исполнитель заносится в список делегирования, который используется в запросах виртуальных папок для отображения делегированных заданий.

.Предыдущий исполнитель определяется в зависимости от того, кто выполняет операцию делегирования:
* Если исполнитель, то он и будет предыдущим исполнителем.
* Если заместитель, то предыдущим будет его руководитель (для сценария с распределением заданий). Если заместитель хочет выполнить делегирование от своего имени, он должен сначала взять задание в работу.
* Если контролер или автор, то предыдущим будет текущий исполнитель.
+
Если текущий исполнитель является альтернативным, то в форме делегирования нужно будет выбрать, кого из альтернативных исполнителей считать предыдущим исполнителем.

Возможность делегирования определяется настройками в _Конструкторе ролей._

.Типовая конфигурация системы подразумевает следующие роли:
* Активный исполнитель задания.
* Его заместитель.
* Контролер или автор задания.

Кроме того, задание может быть делегировано автоматически функцией задания.

Если делегирование запрещено, будет выведено сообщение об ошибке: `Данное задание запрещено делегировать`.

.Чтобы делегировать задание:
. Нажмите на кнопку *Делегировать* на ленте карточки задания.
+
Будет выведено окно, позволяющее выбрать сотрудника, которому будет делегировано задание:
+
.Окно выбора делегатов
image::task-select-delegate.png[Окно выбора делегатов]
+
. В поле _Делегаты_ выберите делегатов из _Справочника сотрудников_ или из заранее сформированного списка сотрудников, сформированного в _Справочнике видов карточек_.
. При необходимости в поле _Комментарий_ введите текстовый комментарий, который получит делегат.
. Чтобы запретить делегату дальнейшее делегирование задания, установите флаг `*Запретить делегирование*`.
. Чтобы задание, выполненное сотрудником, которому оно было делегировано, автоматически вернулось в состояние `Возврат с делегирования` первоначальному исполнителю (или тому, кому отправили уведомление при делегировании в случае альтернативного делегирования), установите флаг `*Возврат с делегирования*`.

[#accept]
== Приёмка задания

Переход состояние `На приёмке` будет произведен только при установке в карточке задания флага xref:task/create.adoc#control["Требуется приёмка"]. В этом случае вместо перехода в состояние `Завершение` произойдет переход в состояние `На приёмке`.

Данное состояние возможно только для окончательно завершаемых заданий. При возврате задания с делегирования перехода в данное состояние не происходит.

Перед переходом в состояние `На приёмке` производится проверка параметров завершения задания.

.Из состояния "На приёмке" пользователю доступны две операции:
* *Принять* -- операция переводит задание в состояние `Завершено`.
* *На доработку* -- операция переводит задание в состояние `На доработке`. При возврате задания на доработку значение поля _Дата завершения фактическая_ будет удалено.

[#finish]
== Завершить задание

Завершение задания производится после того как работа над заданием будет завершена.

.Завершение задания возможно из следующих состояний:
* `Не начато` -- задание завершается сразу же после его получения.
* `В работе` -- задание завершается после того как была выполнена задача, поставленная исполнителю в задании.
* `Возврат с делегирования` -- задание завершается сразу после того как задание было возвращено от последнего делегата.

Способ завершения задания и связанных с ним заданий зависит от xref:task/advanced-settings.adoc#finishing-settings[параметров завершения], определённых пользователем в _Справочнике видов карточек_ или в самом задании.

.При завершении задания от пользователя может потребоваться заполнение:
* Файла или ссылки отчёта -- если для задания установлен флаг `*При завершении задания необходимо добавить файл отчёта*`.
* Отчёта, файла отчёта или ссылки отчёта -- если для задания проставлен флаг `*При завершении задания необходимо ввести отчёт*`.
* Полей, указанных в настройке вида карточки задания _При завершении задания необходимо заполнить поля_ с признаком `*Обязательно*`.

При необходимости производится возврат задания с делегирования. Если сотрудник, которому возвращается задание, не активен, и в задании установлен флаг `*Автоматически делегировать заместителю*`, выполняется автоматическое делегирование возврата. Текущим исполнителем становится заместитель.

Если карточка задания перешла в состояние `Завершено`, будут принудительно завершены дочерние и родительские задания в соответствии с xref:task/advanced-settings.adoc#finishing-settings[настройками] вида задания в _Справочнике видов карточек_ или самом задании:

* Когда у задания есть подчиненные, они будут принудительно завершены, если в настройках задания (вида задания) установлен флаг `*При завершении задания автоматически завершать подчиненные*`.
* Когда у задания есть родительское, для родительского проверяется настройка `*Автоматическое завершение при завершении подчиненных*`. Родительское задание будет принудительно завершено, если выполняется условие настройки.

Если связанные задания не могут быть завершены (например, если они заблокированы), будут выполнены действия в зависимости от настройки _Завершение задания при невозможности завершения связанных_:

* *Разрешить* -- заблокированные задания будут пропущены, произойдет завершение задания.
* *Запретить* -- пользователю будет выдано предупреждающее сообщение со списком заблокированных заданий, после чего процесс прекращения подчиненных заданий будет завершен.
* *На усмотрение пользователя* -- пользователю будет выдано предупреждающее сообщение со списком заблокированных заданий, с вариантами ответа *Продолжить* или *Прекратить* завершение задания.

После нажатия кнопки *Завершить* в журнале событий карточки основного и связанного задания появляется соответствующая запись:

* Если задание завершено:
** Текущий пользователь.
** Завершено или Прекращено исполнение -- в зависимости от операции.
* Если выполнен возврат с делегирования:
** Текущий пользователь.
** Возвращено с делегирования "Текущему исполнителю".
* Если выполнялось автоматическое делегирование при возврате, делается дополнительная запись в журнале:
** Задание автоматически делегировано заместителю "ФИО" в связи с тем, что назначенный исполнитель задания "ФИО" не активен.

[#stop]
== Прекратить исполнение задания

Прекратить исполнение задания можно, чтобы принудительно завершить задание. Прекратить задание можно только из состояния `В работе`.

Когда задание прекращаются принудительно, параметры завершения, определённые в _Справочнике видов карточек_, не учитываются. В том числе, не проверяется необходимость добавления отчёта.

Возврат задания с делегирования не выполняется, и не проверяется заполнение обязательных полей.

После нажатия кнопки *Прекратить* в журнале событий карточки появляется соответствующая запись.
